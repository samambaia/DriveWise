/**
 * @file Firebase Security Rules for IDriveApp
 * @description This ruleset enforces a strict user-ownership model for financial periods and transactions,
 *              while allowing public read access to application settings (categories and ride apps).
 *
 * Data Structure:
 * - /categories, /rideApps: Public collections for storing application settings.
 * - /users/{userId}/periods/{periodId}: Private collections storing user-specific financial periods.
 * - /users/{userId}/periods/{periodId}/transactions/{transactionId}: Private subcollections storing user-specific transactions within a period.
 *
 * Key Security Decisions:
 * - Public read access is granted to the 'categories' and 'rideApps' collections to allow all users to access them.
 * - Authenticated users are allowed to write to 'categories' and 'rideApps'.
 * - Strict user-ownership is enforced for 'periods' and 'transactions'. Users can only access data under their own user ID.
 * - Data consistency is enforced between the path and the document's internal fields for user-owned data.
 * - User listing is disallowed by default.
 *
 * Denormalization for Authorization:
 * - Transactions contain a 'periodId' field, denormalizing the parent relationship for efficient querying and rule enforcement.
 *
 * Structural Segregation:
 * - Public settings are stored in top-level collections, while private user data is stored under /users/{userId}.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows public read access to the categories collection, and write access for authenticated users.
     * @path /categories/{categoryId}
     * @allow (get, list) All users can read categories.
     * @allow (write) Authenticated users can manage categories.
     * @principle Public read access for settings, authenticated write for customization.
     */
    match /categories/{categoryId} {
      allow get, list: if true;
      allow write: if request.auth != null;
    }

    /**
     * @description Allows public read access to the rideApps collection, and write access for authenticated users.
     * @path /rideApps/{rideAppId}
     * @allow (get, list) All users can read ride apps.
     * @allow (write) Authenticated users can manage ride apps.
     * @principle Public read access for settings, authenticated write for customization.
     */
    match /rideApps/{rideAppId} {
      allow get, list: if true;
      allow write: if request.auth != null;
    }

    /**
     * @description Enforces user-ownership for financial periods.
     * @path /users/{userId}/periods/{periodId}
     * @allow (create) User can create a period if the userId matches the authenticated user's ID.
     * @allow (get, list) User can read their own periods.
     * @allow (update, delete) User can update/delete their own existing periods.
     * @deny (create) User cannot create a period for another user.
     * @deny (update, delete) User cannot update/delete a period that does not belong to them or that doesn't exist.
     * @principle Enforces document ownership for writes, validates relational integrity, and prevents unauthorized access.
     */
    match /users/{userId}/periods/{periodId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(path);
      }

      allow create: if isSignedIn()
                   && isOwner(userId)
                   && request.resource.data.id == periodId;
      allow get, list: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn()
                    && isOwner(userId)
                    && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for transactions within a financial period.
     * @path /users/{userId}/periods/{periodId}/transactions/{transactionId}
     * @allow (create) User can create a transaction if the userId and periodId matches the authenticated user's ID and the period ID.
     * @allow (get, list) User can read their own transactions within their own periods.
     * @allow (update, delete) User can update/delete their own existing transactions within their own periods.
     * @deny (create) User cannot create a transaction for another user or period.
     * @deny (update, delete) User cannot update/delete a transaction that does not belong to them or that doesn't exist.
     * @principle Enforces document ownership for writes, validates relational integrity, and prevents unauthorized access.
     */
    match /users/{userId}/periods/{periodId}/transactions/{transactionId} {
       function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(path);
      }

      allow create: if isSignedIn()
                   && isOwner(userId)
                   && request.resource.data.periodId == periodId
                   && request.resource.data.id == transactionId;
      allow get, list: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn()
                   && isOwner(userId)
                   && request.resource.data.periodId == resource.data.periodId
                   && request.resource.data.id == resource.data.id;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
  }
}

    